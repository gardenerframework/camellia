# 访问控制的根本

从计算机编程的角度出发，所谓的权限控制就是对来访者(用户/客户端)的身份首先进行登录确认，之后对确认后的身份内的某个属性进行逻辑判断，满足放行

```java
public class SecretFileEndpoint {
    public SecretFile read(String id) {
        User user = SecurityContext.getContext().getAuthentication();
        if (user != null && user.hasPrivelledge('read-secret-file')) {
            return service.readFile(id);
        } else {
            throw new FobiddenException();
        }
    }
}
```

如上面所示，程序去判断用户是否有权限去读机密文件，有就操作，没有则禁止访问。

这段逻辑反映出了访问控制的根本，那就是

* 定义以字符串为类型的，常量化的权限编码，如`"read-secret-file"`
* 在程序中通过判断用户的某个属性是否含有所需的编码，有放行，没有禁止操作

因此，所谓的权限，在计算机世界的表达就是字符串常量集

# 权限的适用范围

天下没有一张通行证能实现所有地方都放行，因此权限也有它的适用范围，任何系统不会有一个权限的定义范围是无穷大。

## 第一边界: 应用

一个大型的集成系统是由多个不同的自应用构成的，比如一个电商的后台系统是由商品管理应用、支付管理应用、订单管理应用等构成。这些应用自己会定义使用者在其中的权限，其权限的逻辑只在这些应用内生效，罕有要求跨应用生效的需求以及能力。同时，这也是因为这些应用一般由不同的团队甚至公司开发和维护，彼此之间的互相依赖越少，系统越健壮

在大型系统中也一定有一个应用模块叫做人员管理，在这里会操作生成系统的组织和人员，并且有对应的是否能添加账户、能否管理账户状态等权限的设计产生。此时应当注意到，它的权限范围也是在管理模块内有效的。
比如一个用户A具有添加账号的权限，它是指能够为系统添加账号。而系统中有一个供应商管理系统，A能不能管理这个子系统的供应商的账号，恐怕需要考察A是否具有对应子系统的人员操作权，而不能因为A能管理系统人员，所以A等价于在任何一个子系统中都能管理账号

## 第二边界: 组织

第二边界一般是针对人员管理模块和应用来说的，系统内动态定义的数据包含组织、人员和角色(
上文说了，权限是倾向于常量化表达的数据)。那么对于这些数据的操作权限存在一个默认边界，就是组织。
所有权限在组织内部生效并允许向下行权，如添加账户，一般不能向兄弟部门添加人员，如定义角色，不能去定义上级部门的角色

## 第三边界: 分组

第三边界是一种弱约定，首先需要明确，分组是扁平化的人员群组，不存在层级结构。应用所管理的资源一般有些是绑定到分组的，作为分组的共享资源(
意思是不视作个人资源)
使用，如文件或其它数据库记录，比如客户。这是描述的权限实际上是默认在分组内生效的，比如文件的编辑权，比如查看客户的电话号码。A组的持有权限的人必然不能将权限穿透分组去操作其它组的数据

## 小结

其实不难发现，权限的范围与应用数据的使用范围基本一致，因此在系统中设计一个权限编码时，应当考虑这个权限的适用范围是什么。比如编辑文件这个权限，不同应用之间最好通过附加前缀或后缀等方式去定义不同的编码，而不是复用其它系统的编码，否则小心使用者在另一个系统的赋权不小心影响到当前系统

# 角色

RBAC有一个坑的点就是叫做基于'角色'的访问控制，然而其实系统的控制是基于权限的，角色是权限的集合体。
在一个系统中和应用中，角色都是动态定义的，并且当要管理这个角色时候也需要明确的知道这个角色到底能做什么。
因此首先一个动态定义的数据不太好在代码中通过常量枚举的方式去定义和匹配，此外最终角色到底能干什么还是要将它绑定到权限上才行。

## 预设角色

当然，为了简化系统的设计，部分角色是可以常量化预设，主要是系统的管理员。

系统的管理员被视作是一种超级账户，它对于系统的人员、组织、权限有绝对的操作权，意味着它不需要被分配权限就能执行操作，当系统的人员、组织、权限和角色出现新的权限定义时，管理员也不需要被分配新的权限才能执行操作。比如:

* 系统初始时，人员的密码不能后台重置
* 新版本新增加了重置密码的功能并新增了一个权限编码叫做`"reset-password"`
* 此时系统管理员是不需要被分配这个权限也能重置任何组织任何账户的密码

## 角色的边界

原则上，角色同样存在上面的3个边界，不同应用之间的角色，不同组织之间的角色，不同分组之间的角色不会互认

# 结语

RBAC其实最终的控制是落在权限上，权限的编码建议是全局唯一的，这样有效防止具有多个应用访问权的人在应用之间切换时，权限发生非预期的边界穿透的情况。
角色是权限的集合体，但应当支持设置预设角色，这类角色一般是管理员级别的角色，意味着不需要赋权就能执行管理动作